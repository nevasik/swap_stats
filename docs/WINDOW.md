**окна** — это наш быстрый, всегда-актуальный «горячий кэш агрегаций» в памяти сервиса. Они решают две ключевые задачи:

1. **Realtime-ответы без запросов в ClickHouse**
   Клиент спрашивает: «дай 5m/1h/24h по токену». Мы отвечаем сразу из RAM (O(1)), не трогая CH — п95 ~ миллисекунды

2. **Стрим обновлений в WebSocket**
   Как только пришло новое событие мы обновили окна и отправили маленький «патч» подписчикам. Без окон пришлось бы собирать агрегаты заново

Если бы окон **не было**:
* каждый HTTP-запрос = «считай агрегаты по сырью» в ClickHouse → это секунды/сотни миллисекунд под нагрузкой + высокая стоимость
* стрим апдейтов делать нечем: пока ClickHouse пересчитает — realtime пропал
* поздние события (out-of-order) было бы тяжело аккуратно учитывать — окна со *grace* позволяют корректно донакручивать прошлые минуты

---

## Что именно делают окна
* Держат **кольцевые минутные бакеты** на последние 24 часа (фикс. память)
* Поддерживают **скользящие суммы** на 5m/1h/24h (обновляются инкрементально, O(1))
* Имеют **watermark + grace** (например, 120 с), чтобы аккуратно учесть опоздавшие события.
* Делают **снапшот** в Redis → «тёплый старт» после рестарта за миллисекунды.

---

# Где окна стоят в общей схеме
## Поток данных (ingest)

```
┌──────────┐     ┌───────────────┐     ┌────────────┐     ┌──────────────┐
│ Producer │ →→  │ Kafka/Redpanda│ →→  │ Consumer   │ →→  │ WindowEngine │
└──────────┘     └───────────────┘     └────────────┘     └─────┬────────┘
                                                                ┌─▼──────────┐
                                                                │ NATS       │ → WS fan-out
                                                                └────────────┘
                                         ┌──────────────────────┐
                                         │ ClickHouse (batch)   │ ← сырые события
                                         └──────────────────────┘
```

На каждом сообщении: **dedup → apply в окна → батч в CH → патч в NATS/WS**.

## Путь HTTP/WS

```
HTTP /api/tokens/:id/stats → WindowEngine.GetWindows() → JSON из RAM
WS подписка token:USDC     ← WindowEngine apply → coalesce 100ms → патчи клиентам
```

---

# Таймлайн одного события

```
t0: событие пришло из Kafka
    ├─ дедуп: уже видели? если нет — пропускаем дальше
    ├─ WindowEngine.Apply:
    │    • кладём объём/счётчики в минутный бакет (event_time → minute slot)
    │    • обновляем rolling 5m/1h/24h (O(1))
    │    • если событие опоздавшее, но в пределах grace → корректно «докручиваем»
    ├─ публикуем патч в NATS → WS-зрителям
    └─ отправляем запись в ClickHouse (batch)
```

---

# Почему не «только ClickHouse / MV»?

* **ClickHouse Materialized Views** хороши для суточных/минутных витрин, но:

    * латентность — как минимум задержка вставки+мержей;
    * отдавать *каждый запрос* из CH — дороже и медленнее, чем из RAM;
    * realtime-WS всё равно потребует слой, который пушит апдейты — а откуда брать «дельты»? Окна дают их сразу.

Итоговая связка: **окна (горячее realtime-состояние)** + **ClickHouse (надёжное долговременное хранилище и оффлайн-аналитика)**.

---

# Где именно вызываются окна

* **На ingest**: `WindowEngine.Apply(ctx, event)` — на каждое принятое сообщение;
* **На HTTP**: `WindowEngine.GetWindows(ctx, tokenKey)` — при запросе клиента;
* **Фоново каждую минуту**: `WindowEngine.Tick(now)` — продвигаем watermark, закрываем минуты;
* **Периодически**: `Snapshot()` в Redis и `Restore()` при старте;

---

# Что дают окна прикладному уровню

* `/api/overview` и `/api/tokens/{id}/stats` быстрее и дешевле → хороший UX и низкие p95.
* WS-клиенты видят **живые** изменения (10 Гц коалесинг) без перегрузки сети.
* Поздние/отменённые события (reorg) корректно отражаются: окно пересчитает минуту и отправит **компенсирующий патч**

---

# Мини-пример ответа что видит клиент

```json
{
  "token": "USDC",
  "w5m":  { "vol_usd": 12345.67, "trades": 321,  "buy": 200, "sell": 121 },
  "w1h":  { "vol_usd": 45678.90, "trades": 987,  "buy": 600, "sell": 387 },
  "w24h": { "vol_usd": 123456.7, "trades": 5432, "buy": 3000,"sell": 2432 }
}
```

WS-патч — это «дельта» к такому же объекту (например, изменилась только `w5m.vol_usd` и `w5m.trades`)

---

# Резюме
Окна — это **сердце realtime-части**:
* мгновенные ответы и пуш-апдейты;
* корректность при out-of-order через *grace*;
* предсказуемая память (фиксированные бакеты);
* «тёплый старт» через снапшоты;

Без них сервис стал бы либо медленным (каждый раз лезть в CH), либо «нереалтаймовым» (нет быстрых дельт для WS), либо дорогим по ресурсам
