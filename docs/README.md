# Swap Stats ‚Äî Implementation Guide

# –ê–≤—Ç–æ—Ä: **telegram - @nevasik**

> –¶–µ–ª—å: –ø–æ—à–∞–≥–æ–≤–æ, –ø–æ–Ω—è—Ç–Ω–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ä–≤–∏—Å –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ —Å–≤–æ–ø–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (1000 EPS), —Å –Ω–∏–∑–∫–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, High Availability, –¥–µ–¥—É–ø–æ–º, —Å–∫–æ–ª—å–∑—è—â–∏–º–∏ –æ–∫–Ω–∞–º–∏, —Å–Ω–∞–ø—à–æ—Ç–∞–º–∏ –∏ –≤—ã–¥–∞—á–µ–π —á–µ—Ä–µ–∑ HTTP/WS.
> –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º **Redpanda** (Kafka API), –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –±—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –Ω–∞ **Apache Kafka**.

---

## üì¶ Postman –ö–æ–ª–ª–µ–∫—Ü–∏—è

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API –¥–æ—Å—Ç—É–ø–Ω–∞ –≥–æ—Ç–æ–≤–∞—è Postman –∫–æ–ª–ª–µ–∫—Ü–∏—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–¥–∞—á–µ–π JWT —Ç–æ–∫–µ–Ω–æ–≤:

- **[Dexcelerate_API.postman_collection.json](./Dexcelerate_API.postman_collection.json)** - –ü–æ–ª–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –≤—Å–µ—Ö endpoints
- **[Dexcelerate_Local.postman_environment.json](./Dexcelerate_Local.postman_environment.json)** - –û–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **[Dexcelerate_Staging.postman_environment.json](./Dexcelerate_Staging.postman_environment.json)** - –û–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è staging
- **[POSTMAN_GUIDE.md](./POSTMAN_GUIDE.md)** - –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç —Å Postman:

1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ Postman —Ñ–∞–π–ª—ã –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
2. –í—ã–±–µ—Ä–∏—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ **Dexcelerate Local**
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ **Public Endpoints ‚Üí Mint JWT Token**
4. –¢–æ–∫–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∏ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤–æ –≤—Å–µ—Ö –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö endpoints

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: [POSTMAN_GUIDE.md](./POSTMAN_GUIDE.md)

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–¢–ó](#—Ç–∑)
2. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
3. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
4. [–ì–ª–æ—Å—Å–∞—Ä–∏–π (—Ç–µ—Ä–º–∏–Ω—ã –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏)](#–≥–ª–æ—Å—Å–∞—Ä–∏–π-—Ç–µ—Ä–º–∏–Ω—ã-–ø—Ä–æ—Å—Ç—ã–º–∏-—Å–ª–æ–≤–∞–º–∏)
5. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ø–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∏-–ø–æ—Ç–æ–∫–∏-–¥–∞–Ω–Ω—ã—Ö)
6. [–õ–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–Ω–¥ (Docker Compose)](#–ª–æ–∫–∞–ª—å–Ω—ã–π-—Å—Ç–µ–Ω–¥-docker-compose)
7. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ (`config.yaml`)](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è-—Å–µ—Ä–≤–∏—Å–∞-configyaml)
8. [–î–∞–Ω–Ω—ã–µ –∏ –¥–æ–º–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏](#–¥–∞–Ω–Ω—ã–µ-–∏-–¥–æ–º–µ–Ω–Ω—ã–µ-–º–æ–¥–µ–ª–∏)
9. [–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è (Dedup)](#–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è-dedup)
10. [–û–∫–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫: –∫–æ–ª—å—Ü–µ–≤—ã–µ –±—É—Ñ–µ—Ä—ã + rolling-—Å—É–º–º—ã + grace](#–æ–∫–æ–Ω–Ω—ã–π-–¥–≤–∏–∂–æ–∫-–∫–æ–ª—å—Ü–µ–≤—ã–µ-–±—É—Ñ–µ—Ä—ã--rolling-—Å—É–º–º—ã--grace)
11. [–°–Ω–∞–ø—à–æ—Ç—ã (Snapshot/Restore)](#—Å–Ω–∞–ø—à–æ—Ç—ã-snapshotrestore)
12. [Ingest –∏–∑ Redpanda/Kafka](#ingest-–∏–∑-redpandakafka)
13. [–î–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ: ClickHouse + —Å—É—Ç–æ—á–Ω—ã–µ MV](#–¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ-—Ö—Ä–∞–Ω–µ–Ω–∏–µ-clickhouse--—Å—É—Ç–æ—á–Ω—ã–µ-mv)
14. [HTTP API + JWT + Rate Limiting](#http-api--jwt--rate-limiting)
15. [WebSocket + –∫–æ–∞–ª–µ—Å–∏–Ω–≥ + –∫–ª–∞—Å—Ç–µ—Ä–Ω—ã–π —Ñ–∞–Ω-–∞—É—Ç (NATS)](#websocket--–∫–æ–∞–ª–µ—Å–∏–Ω–≥--–∫–ª–∞—Å—Ç–µ—Ä–Ω—ã–π-—Ñ–∞–Ω-–∞—É—Ç-nats)
16. [–ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å: –º–µ—Ç—Ä–∏–∫–∏ –∏ pprof](#–Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å-–º–µ—Ç—Ä–∏–∫–∏-–∏-pprof)
17. [–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ Redpanda ‚áÑ Kafka](#–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ-redpanda--kafka)
18. [–¢–µ—Å—Ç-–ø–ª–∞–Ω (unit/integration/load)](#—Ç–µ—Å—Ç-–ø–ª–∞–Ω-unitintegrationload)
19. [Runbook (–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞)](#runbook-–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ-–ø—Ä–∞–≤–∏–ª–∞)
20. [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–∫–æ–º–∞–Ω–¥—ã)](#–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç-–∫–æ–º–∞–Ω–¥—ã)
21. [–ß–µ–º –±—É–¥–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –ø—Ä–æ–¥–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç —Ç–µ–∫—É—â–µ–π](#–ß–µ–º-–±—É–¥–µ—Ç-–æ—Ç–ª–∏—á–∞—Ç—å—Å—è-PROD-config-–æ—Ç-—Ç–µ–∫—É—â–µ–≥–æ-dev)

--- 
## –¢–ó
–£ –≤–∞—Å –µ—Å—Ç—å 1000 —Å–≤–æ–ø–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É –æ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è (–∫—Ç–æ, —Ç–æ–∫–µ–Ω, —Å—É–º–º–∞, –¥–æ–ª–ª–∞—Ä –°–®–ê, —Å—Ç–æ—Ä–æ–Ω–∞ –∏ —Ç.–¥).
–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å —Ç–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É, –∫–æ—Ç–æ—Ä–∞—è –≤—ã—á–∏—Å–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏(–æ–±—ä–µ–º –∑–∞ 5 –º–∏–Ω—É—Ç, –æ–±—ä–µ–º –∑–∞ 1 —á–∞—Å, –æ–±—ä–µ–º –∑–∞ 24 —á–∞—Å–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ —Ç.–¥)
–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ HTTP API –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è WebSocket —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π.

–°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—Å–æ–∫–æ–¥–æ—Å—Ç—É–ø–Ω–æ–π –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –ø—Ä–æ–ø—É—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤–æ –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞.
–û–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–π, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –±–æ–ª—å—à–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤.
–î–∞–Ω–Ω—ã–µ —Å–≤–æ–ø–æ–≤ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã, –∞ –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–æ–≤ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è.

1. –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞. –°–ø—Ä–æ–µ–∫—Ç–∏—Ä—É–π—Ç–µ –ø–æ–ª–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É.
- –ö–∞–∫–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –≤—ã –±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –æ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è?
- –ì–¥–µ –≤—ã –±—ã —Ö—Ä–∞–Ω–∏–ª–∏ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö?
- –ö–∞–∫ –≤—ã –±—ã –æ–±–µ—Å–ø–µ—á–∏–ª–∏ –≤—ã—Å–æ–∫—É—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ—Ç–µ—Ä—å –¥–∞–Ω–Ω—ã—Ö?

2. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Å–µ—Ä–≤–∏—Å Go, –∫–æ—Ç–æ—Ä—ã–π:
- —Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è —Å–≤–æ–ø–∞ –∏–∑ –∫–∞–Ω–∞–ª–∞
- –≤—ã—á–∏—Å–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ HTTP
- –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª WebSocket
- –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏.
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è.

![img.png](img.png)
---

## –û–±–∑–æ—Ä

–ú—ã —Å—Ç—Ä–æ–∏–º —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π:

* –ø—Ä–∏–Ω–∏–º–∞–µ—Ç \~**1000 —Å–æ–±—ã—Ç–∏–π/—Å–µ–∫** (EPS),
* —Å—á–∏—Ç–∞–µ—Ç **—Å–∫–æ–ª—å–∑—è—â–∏–µ –æ–∫–Ω–∞** –ø–æ —Ç–æ–∫–µ–Ω–∞–º: 5m / 1h / 24h,
* **–æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã** (–¥–µ–¥—É–ø),
* –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç **–æ–ø–æ–∑–¥–∞–≤—à–∏–µ —Å–æ–±—ã—Ç–∏—è** (grace),
* —Ö—Ä–∞–Ω–∏—Ç —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ **ClickHouse** 90 –¥–Ω–µ–π,
* –æ—Ç–¥–∞—ë—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ **HTTP** –∏ **WebSocket** —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π,
* –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç —Ä–µ—Å—Ç–∞—Ä—Ç—ã –±–µ–∑ –ø–µ—Ä–µ—Ä–∞—Å—á—ë—Ç–∞ —Å—É—Ç–æ–∫ ‚Äî —á–µ—Ä–µ–∑ **—Å–Ω–∞–ø—à–æ—Ç—ã**,
* –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ, High Availability.

---

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

* **–ë—Ä–æ–∫–µ—Ä:** Redpanda (Kafka API). –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ Apache Kafka.
* **–•—Ä–∞–Ω–∏–ª–∏—â–∞:** Redis (–¥–µ–¥—É–ø, —Å–Ω–∞–ø—à–æ—Ç—ã, rate-limit), ClickHouse (raw), NATS (–∫–ª–∞—Å—Ç–µ—Ä–Ω—ã–π —Ñ–∞–Ω-–∞—É—Ç –¥–ª—è WS).
* **Cold storage:** S3/MinIO (ClickHouse storage policy: HOT ‚Üí COLD(S3)).
* **–Ø–¥—Ä–æ:** Go 1.22+, chi (HTTP), nhooyr/websocket (WS), —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ª–æ–≥–≥–µ—Ä - –æ–±–µ—Ä—Ç–∫–∞(zerolog) + alert manager to telegram API.
* **–ú–µ—Ç—Ä–∏–∫–∏:** Prometheus, pprof.

---

## –ì–ª–æ—Å—Å–∞—Ä–∏–π

* **–î–µ–¥—É–ø (deduplication):** —Ñ–∏–ª—å—Ç—Ä –¥—É–±–ª–µ–π. –û–¥–Ω–æ –∏ —Ç–æ –∂–µ —Å–æ–±—ã—Ç–∏–µ —É—á–∏—Ç—ã–≤–∞–µ–º **—Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑**.
* **–ö–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä (ring):** –º–∞—Å—Å–∏–≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞, –∏–¥—É—â–∏–π ‚Äú–ø–æ –∫—Ä—É–≥—É‚Äù ‚Äî –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –º–∏–Ω—É—Ç—É `minute % size`.
* **–û–∫–Ω–∞ (5m/1h/24h):** –º–µ—Ç—Ä–∏–∫–∏ ‚Äú–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –º–∏–Ω—É—Ç/—á–∞—Å–æ–≤/—Å—É—Ç–æ–∫‚Äù.
  **Rolling-—Å—É–º–º—ã** –ø–æ–∑–≤–æ–ª—è—é—Ç –æ—Ç–¥–∞–≤–∞—Ç—å –∏—Ö –∑–∞ O(1), –±–µ–∑ –ø–µ—Ä–µ—Å—á—ë—Ç–∞.
* **Grace:** –¥–æ–ø—É—Å–∫ –æ–ø–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 120 —Å–µ–∫—É–Ω–¥).
* **–°–Ω–∞–ø—à–æ—Ç:** ‚Äú—Ñ–æ—Ç–æ RAM-—Å–æ—Å—Ç–æ—è–Ω–∏—è‚Äù + —Ç–µ–∫—É—â–∏–µ offsets —Å—Ç—Ä–∏–º–∞, —á—Ç–æ–±—ã **—Ç—ë–ø–ª–æ** —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞.
* **At-least-once:** –¥–æ—Å—Ç–∞–≤–∫–∞ –º–æ–∂–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è ‚Üí –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–µ–Ω –¥–µ–¥—É–ø.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ø–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

1. **Ingest** (Consumer Group) —á–∏—Ç–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ Redpanda/Kafka.
2. **Dedup** (Redis SETNX/TTL) –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç –¥—É–±–ª–∏ –ø–æ `event_id`.
3. **–û–∫–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫** –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∏–≤–µ–Ω—Ç –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π **–º–∏–Ω—É—Ç–Ω—ã–π –±–∞–∫–µ—Ç** (ring) –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç **rolling** 5m/1h/24h.
   –£—á–∏—Ç—ã–≤–∞–µ–º **grace** –¥–ª—è –ø–æ–∑–¥–Ω–∏—Ö —Å–æ–±—ã—Ç–∏–π.
4. **–°–Ω–∞–ø—à–æ—Ç** —Å–æ—Å—Ç–æ—è–Ω–∏—è + offsets –∫–∞–∂–¥—ã–µ 5s –≤ Redis ‚Üí –±—ã—Å—Ç—Ä—ã–π —Ä–µ—Å—Ç–∞—Ä—Ç.
5. **WS push**: –ª–æ–∫–∞–ª—å–Ω—ã–π —Ö–∞–± ‚Üí –∫–æ–∞–ª–µ—Å–∏–Ω–≥ 100ms ‚Üí –∫–ª–∏–µ–Ω—Ç—ã; –º–µ–∂-–∏–Ω—Å—Ç–∞–Ω—Å–æ–≤—ã–π —Ñ–∞–Ω-–∞—É—Ç —á–µ—Ä–µ–∑ **NATS**.
6. **ClickHouse**: –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å ‚Äú—Å—ã—Ä—å—è‚Äù –±–∞—Ç—á–∞–º–∏; —Å—É—Ç–æ—á–Ω—ã–µ MV –¥–ª—è –æ—Ç—á—ë—Ç–æ–≤.
7.  **S3**: –∑–∞–ª–æ–∂–∏–º —Ö–æ–ª–æ–¥–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑ ClickHouse –≤ bucket S3.
---

## –õ–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–Ω–¥ (Docker Compose)

–ü–æ–¥–Ω–∏–º–∞–µ–º **Redpanda, Redis, NATS, ClickHouse**. Redpanda ‚Äî –¥–µ—Ñ–æ–ª—Ç.
(–ú–æ–∂–Ω–æ –ø–æ–¥–Ω—è—Ç—å Apache Kafka, –∫–æ–¥ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)

–ú–∏–Ω–∏-—Ñ—Ä–∞–≥–º–µ–Ω—Ç:

```yaml
services:
  redpanda:
    image: redpandadata/redpanda:v24.1.7
    command: >
      redpanda start --overprovisioned --smp 1 --memory 1G --reserve-memory 0M
      --node-id 0 --check=false --set redpanda.auto_create_topics_enabled=true
    ports: ["9092:9092"]

  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]

  nats:
    image: nats:2.10-alpine
    command: -js
    ports: ["4222:4222"]

  clickhouse:
    image: clickhouse/clickhouse-server:23.8
    environment:
      - CLICKHOUSE_DB=swaps
      # --- S3 creds (–≤ –ø—Ä–æ–¥–µ –≤—ã–Ω–µ—Å—Ç–∏ –≤ secrets/ vault) ---
      - AWS_REGION=eu-central-1
      - S3_BUCKET=ch-swaps-cold
      - S3_ACCESS_KEY=CHANGE_ME
      - S3_SECRET_KEY=CHANGE_ME
    ports: ["9000:9000","8123:8123"]
    volumes:
      - ./clickhouse_data:/var/lib/clickhouse
      - ./clickhouse/config.d/storage.xml:/etc/clickhouse-server/config.d/storage.xml:ro
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ (`config.yaml`)

–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å **Redpanda ‚áÑ Kafka** (–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ `broker_type` –∏ `brokers`):

```yaml
ingest:
  broker_type: redpanda           # redpanda | kafka
  brokers: ["localhost:9092"]
  topic: "raw-swaps"
  group_id: "swap-stats"
  start: "latest"                 # –∏–ª–∏ "earliest"
  max_bytes: 1048576
  topic_cfg:
    partitions: 12
    replication: 1                # dev; –≤ –ø—Ä–æ–¥–µ 3
    retention_ms: 604800000       # 7d
    cleanup_policy: delete
    segment_ms: 3600000           # 1h

app:
  grace: "120s"
  snapshot_interval: "5s"
  dedupe_ttl: "24h"

stores:
  redis:
    addr: "localhost:6379"
    db: 2
    prefix: "swapstats:"
  clickhouse:
    dsn: "tcp://localhost:9000?database=swaps&compress=true"

pubsub:
  nats:
    url: "nats://localhost:4222"

security:
  jwt:
    enabled: true
    alg: "HS256"
    secret: "CHANGE_ME"

rate_limit:
  by_jwt: { refill_per_sec: 50, burst: 200 }
  by_ip:  { refill_per_sec: 20, burst: 60 }

api:
  http: { addr: ":8080" }
  ws:   { coalesce_ms: 100, max_conn: 5000 }

metrics:
  prometheus: ":9091"
  pprof: ":6060"
```

**–ü–æ—á–µ–º—É —Ç–∞–∫:**
Redpanda/Kafka ‚Äî –æ–¥–∏–Ω API. –í—Å—è —Ä–∞–∑–Ω–∏—Ü–∞ ‚Äî –∞–¥—Ä–µ—Å–∞ –∏ –∞–¥–º–∏–Ω–∫–∞. –û—Å—Ç–∞–ª—å–Ω–æ–π —Å—Ç–µ–∫ ‚Äî –Ω–µ–∏–∑–º–µ–Ω–µ–Ω.

---

## –î–∞–Ω–Ω—ã–µ –∏ –¥–æ–º–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏

–ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π ID —Å–æ–±—ã—Ç–∏—è: `event_id = "<chain_id>:<tx_hash>:<log_index>"`.

```go
type Side string
const (
  SideBuy  Side = "buy"
  SideSell Side = "sell"
)

type SwapEvent struct {
  EventID      string
  ChainID      uint64
  TxHash       string
  LogIndex     uint
  Token        string   // addr/symbol
  AmountTok    float64
  AmountUSD    float64
  Side         Side
  EventTime    time.Time
  IngestedTime time.Time
  Removed      bool
}

type Agg struct {
  VolumeUSD  float64
  VolumeTok  float64
  Trades     int64
  BuyTrades  int64
  SellTrades int64
}
```

---

## –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è (Dedup)

**–ó–∞—á–µ–º:** at-least-once –¥–æ—Å—Ç–∞–≤–∫–∞ ‚Üí –≤–æ–∑–º–æ–∂–Ω—ã –ø–æ–≤—Ç–æ—Ä—ã. –ë–µ–∑ –¥–µ–¥—É–ø–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Äú—É–ø–ª—ã–≤—ë—Ç‚Äù.

**–ö–∞–∫:** Redis `SETNX` + TTL (–Ω–∞–ø—Ä–∏–º–µ—Ä, 24h). –ö–ª—é—á ‚Äî `dedupe:{event_id}`.

```go
// true => —É–∂–µ –≤–∏–¥–µ–ª–∏ (–¥—É–±–ª–∏–∫–∞—Ç)
func (r *RedisDeduper) Seen(ctx context.Context, id string, ttl time.Duration) (bool, error) {
  ok, err := r.cli.SetNX(ctx, "dedupe:"+id, 1, ttl).Result()
  return !ok, err
}
```

**–ü–æ—á–µ–º—É —Ç–∞–∫:** –≥–ª–æ–±–∞–ª—å–Ω—ã–π –¥–µ–¥—É–ø –¥–ª—è –≤—Å–µ—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤/–ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤.

---

## –û–∫–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫: –∫–æ–ª—å—Ü–µ–≤—ã–µ –±—É—Ñ–µ—Ä—ã + rolling-—Å—É–º–º—ã + grace

**–ö–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä (ring) –∏–∑ –º–∏–Ω—É—Ç–Ω—ã—Ö –±–∞–∫–µ—Ç–æ–≤:**
–†–∞–∑–º–µ—Ä 1440 (24h√ó60). –ò–Ω–¥–µ–∫—Å –ø–æ –º–∏–Ω—É—Ç–µ: `i = (event_time.Unix()/60) % 1440`.
–ï—Å–ª–∏ –±–∞–∫–µ—Ç –≤ —è—á–µ–π–∫–µ –æ—Ç –¥—Ä—É–≥–æ–π –º–∏–Ω—É—Ç—ã ‚Äî –æ–±–Ω—É–ª—è–µ–º –∏ –ø–∏—à–µ–º –Ω–æ–≤—É—é.

```go
type minuteBucket struct {
  Minute int64 // unix minute
  Agg    Agg
}

type tokenRing struct {
  buckets []minuteBucket           // len = 1440
}

func (r *tokenRing) applyEvent(t time.Time, usd, tok float64, buy bool) (delta Agg, minute int64) {
  m := t.Unix() / 60; i := int(m % 1440)
  b := &r.buckets[i]
  if b.Minute != m { *b = minuteBucket{Minute: m} }
  before := b.Agg
  // –æ–±–Ω–æ–≤–ª—è–µ–º –∞–≥—Ä–µ–≥–∞—Ç—ã –±–∞–∫–µ—Ç–∞:
  b.Agg.VolumeUSD += usd
  b.Agg.VolumeTok += tok
  b.Agg.Trades++
  if buy { b.Agg.BuyTrades++ } else { b.Agg.SellTrades++ }
  // –¥–µ–ª—å—Ç–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ rolling:
  delta = b.Agg; delta.VolumeUSD -= before.VolumeUSD; delta.VolumeTok -= before.VolumeTok
  delta.Trades -= before.Trades; delta.BuyTrades -= before.BuyTrades; delta.SellTrades -= before.SellTrades
  return delta, m
}
```

**Rolling-—Å—É–º–º—ã** (O(1) –≤—ã–¥–∞—á–∞ –æ–∫–æ–Ω):
–•—Ä–∞–Ω–∏–º —Ç—Ä–∏ —Å—É–º–º—ã (5m/1h/24h). –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–∏–Ω—É—Ç–Ω–æ–≥–æ –±–∞–∫–µ—Ç–∞ –¥–æ–±–∞–≤–ª—è–µ–º **–¥–µ–ª—å—Ç—É**; —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É –≤—ã—á–∏—Ç–∞–µ–º —Ç–æ, —á—Ç–æ ‚Äú–≤—ã–ø–∞–ª–æ‚Äù –∏–∑ –æ–∫–Ω–∞.

**Grace –¥–ª—è –ø–æ–∑–¥–Ω–∏—Ö —Å–æ–±—ã—Ç–∏–π:**
`watermark = now - grace` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 120s). –ï—Å–ª–∏ `event_time < watermark` ‚Äî —Å—Ç–∞—Ä—å—ë; –∏–Ω–∞—á–µ –ø—Ä–∏–º–µ–Ω—è–µ–º.

**–ü–æ—á–µ–º—É —Ç–∞–∫:** —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–º—è—Ç—å, O(1)/O(min) –æ–ø–µ—Ä–∞—Ü–∏–∏, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏ out-of-order –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö grace.

---

## –°–Ω–∞–ø—à–æ—Ç—ã (Snapshot/Restore)

**–ß—Ç–æ —ç—Ç–æ:** –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è **–≥–æ—Ä—è—á–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è** (–∫–æ–ª—å—Ü–∞ + rolling) + **offsets** —Å—Ç—Ä–∏–º–∞ –≤ Redis.
**–ó–∞—á–µ–º:** ‚Äú—Ç—ë–ø–ª—ã–π —Å—Ç–∞—Ä—Ç‚Äù ‚Äî –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏, –∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º **—Å –Ω—É–∂–Ω–æ–≥–æ –º–µ—Å—Ç–∞**.

**–ö–æ–≥–¥–∞:** –∫–∞–∂–¥—ã–µ 5s + –ø–µ—Ä–µ–¥ graceful shutdown.

–§–æ—Ä–º–∞—Ç (–∏–¥–µ—è):

```go
type WindowSnapshot struct {
  Version  int
  TakenAt  time.Time
  GraceSec int64
  Tokens   map[string]struct{
    Buckets []struct{ Minute int64; Agg Agg }
    W5m, W1h, W24h Agg
  }
  // Offsets —Ö—Ä–∞–Ω–∏–º —Ä—è–¥–æ–º —Ç–µ–º –∂–µ —Ä–µ–≤–∏–∑–∏–æ–Ω–Ω—ã–º –∫–ª—é—á–æ–º
}
```

**–ê–ª–≥–æ—Ä–∏—Ç–º –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏:**

1. Save(state) ‚Üí 2) Save(offsets) —Å —Ç–µ–º –∂–µ `revision`.
   –ù–∞ —Å—Ç–∞—Ä—Ç–µ –∏—â–µ–º **–ø–æ—Å–ª–µ–¥–Ω—é—é —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—É—é –ø–∞—Ä—É** –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º.

**–ü–æ—á–µ–º—É —Ç–∞–∫:** –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ RAM-—Å–æ—Å—Ç–æ—è–Ω–∏—è –∫ –ø–æ–∑–∏—Ü–∏–∏ –≤ —Å—Ç—Ä–∏–º–µ = –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—ã—Ä/–ø–æ–≤—Ç–æ—Ä–æ–≤ –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤.

---

## Ingest –∏–∑ Redpanda/Kafka

**–ü–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:**

1. parse JSON ‚Üí `SwapEvent`
2. **dedup** (Redis SETNX/TTL=24h) ‚Üí –¥—É–±–ª–∏–∫–∞—Ç? –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
3. apply (ring/rolling) —Å —É—á—ë—Ç–æ–º `grace`
4. –æ—Ç–¥–∞—Ç—å –∞–ø–¥–µ–π—Ç –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π WS-hub + **NATS** (–∫–ª–∞—Å—Ç–µ—Ä–Ω—ã–π —Ñ–∞–Ω-–∞—É—Ç)
5. –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ–ª–æ–∂–∏—Ç—å –≤ –±–∞—Ç—á **ClickHouse**
6. **commit offset** (–ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ apply)

**–ü–æ—á–µ–º—É —Ç–∞–∫:** at-least-once + –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å ‚Üí —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ ‚Äú—Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑‚Äù –≤ –º–µ—Ç—Ä–∏–∫–∞—Ö.

---

## –î–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ: ClickHouse + —Å—É—Ç–æ—á–Ω—ã–µ MV

**–ó–∞—á–µ–º:** —Ö—Ä–∞–Ω–∏—Ç—å —Å—ã—Ä—å—ë 90 –¥–Ω–µ–π, –±—ã—Å—Ç—Ä—ã–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã, —Å—É—Ç–æ—á–Ω—ã–µ –≤–∏—Ç—Ä–∏–Ω—ã.

DDL (—Å–º—ã—Å–ª):

```sql
CREATE TABLE IF NOT EXISTS raw_swaps
(
    event_date      Date        DEFAULT toDate(event_time),
    event_time      DateTime64(3, 'UTC'),
    ingested_time   DateTime64(3, 'UTC') DEFAULT now(),
    chain_id        UInt32,
    tx_hash         FixedString(66),
    log_index       UInt32,
    event_id        String,
    token_address   FixedString(42),
    token_symbol    LowCardinality(String),
    pool_address    FixedString(42),
    side            LowCardinality(String),
    amount_token    Decimal(38,18),
    amount_usd      Decimal(20,6),
    block_number    UInt64,
    removed         UInt8,
    schema_version  UInt16
    )
    ENGINE = MergeTree
    PARTITION BY toYYYYMM(event_date)
    ORDER BY (chain_id, token_address, event_time, tx_hash, log_index)
    TTL
    event_date + INTERVAL 90 DAY TO VOLUME 'cold',   -- —á–µ—Ä–µ–∑ 90 –¥–Ω–µ–π ‚Üí S3
    event_date + INTERVAL 365 DAY DELETE             -- —á–µ—Ä–µ–∑ 365 –¥–Ω–µ–π —É–¥–∞–ª–∏—Ç—å
SETTINGS storage_policy = 'hot_to_s3', index_granularity = 8192;
```

–ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–∏—Ç—Ä–∏–Ω–∞ (—Å—É—Ç–æ—á–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã –ø–æ —Ç–æ–∫–µ–Ω—É) ‚Äî –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç—á—ë—Ç–æ–≤.

–ü–∏—à–µ–º –±–∞—Ç—á–∞–º–∏: **–∫–∞–∂–¥—ã–µ \~200 ms** –∏–ª–∏ **–ø–æ 500‚Äì1000** –∑–∞–ø–∏—Å–µ–π (—á—Ç–æ —Ä–∞–Ω—å—à–µ).

---

## –•–æ–ª–æ–¥–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ (S3)
**–•–æ–ª–æ–¥–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ**: ClickHouse ‚Üí S3 (tiering)

**–ó–∞—á–µ–º**: NVMe –¥–µ—Ä–∂–∏—Ç ‚Äú–≥–æ—Ä—è—á–∏–µ‚Äù –ø–∞—Ä—Ç–∏—Ü–∏–∏; —á–µ—Ä–µ–∑ 90 –¥–Ω–µ–π –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–µ–∑–∂–∞—é—Ç –≤ S3 (–¥—ë—à–µ–≤–æ, –¥–æ–ª–≥–æ–≤–µ—á–Ω–æ). –ó–∞–ø—Ä–æ—Å—ã –ø—Ä–æ–∑—Ä–∞—á–Ω—ã –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç**: storage policy hot_to_s3 —Å –¥–∏—Å–∫–∞–º–∏ hot –∏ s3_cold. TTL ... TO VOLUME 'cold' –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–µ–∑–¥.

**–§–æ–Ω–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç ClickHouse**.

---

## HTTP API + JWT + Rate Limiting

**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:**

* `GET /healthz`
* `GET /api/overview` ‚Äî —Ç–æ–ø —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ 5m/1h/24h
* `GET /api/tokens/:id/stats?windows=5m,1h,24h`

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** JWT (HS256 dev / RS256 prod), –ø—Ä–æ–≤–µ—Ä—è–µ–º `exp`, `sub`, `aud`.

**Rate limiting:** Redis Token-Bucket

* –ø–æ **JWT**: 50 rps, burst 200;
* –ø–æ **IP**: 20 rps, burst 60.

**–ü–æ—á–µ–º—É —Ç–∞–∫:** –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –∏ –Ω–∞–≥—Ä—É–∑–∫—É, –æ—Ç–≤–µ—Ç—ã –∏–∑ RAM ‚Äî p95 ‚âà ‚â§ 80 ms.

---

## WebSocket + –∫–æ–∞–ª–µ—Å–∏–Ω–≥ + –∫–ª–∞—Å—Ç–µ—Ä–Ω—ã–π —Ñ–∞–Ω-–∞—É—Ç (NATS)

* –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞: `nhooyr.io/websocket`.
* –ü—Ä–æ—Ç–æ–∫–æ–ª: `{"subscribe":"token:USDC"}`; —Å–µ—Ä–≤–µ—Ä —à–ª—ë—Ç **JSON-–ø–∞—Ç—á–∏** —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –æ–∫–æ–Ω.
* **–ö–æ–∞–ª–µ—Å–∏–Ω–≥:** –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–¥–Ω–∏–º –ø–∞–∫–µ—Ç–æ–º **—Ä–∞–∑ –≤ 100 ms** (10 –ì—Ü).
* **Backpressure:** –±—É—Ñ–µ—Ä –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞; –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ ‚Äî –ø—Ä–æ—Ä–µ–∂–∏–≤–∞–Ω–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ ‚Äú–º–µ–¥–ª–µ–Ω–Ω—ã—Ö‚Äù.
* **NATS:** –º–µ–∂-–∏–Ω—Å—Ç–∞–Ω—Å–æ–≤—ã–π —Ñ–∞–Ω-–∞—É—Ç (`ws.broadcast.token.*`), —á—Ç–æ–±—ã –≤—Å–µ –ø–æ–¥—ã –≤–∏–¥–µ–ª–∏ –∞–ø–¥–µ–π—Ç—ã.

**–ü–æ—á–µ–º—É —Ç–∞–∫:** –ø–æ—á—Ç–∏ realtime, –±–µ–∑ –ª–∞–≤–∏–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –ø–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞–º.

---

## –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å: –º–µ—Ç—Ä–∏–∫–∏ –∏ pprof

**Prometheus:**

* `events_ingested_total`, `events_applied_total`
* `dedupe_hits_total`
* `consumer_lag_seconds`
* `window_apply_latency_ms` (hist)
* `snapshot_duration_ms` (hist)
* `ws_clients_gauge`, `ws_dropped_msgs_total`
* `clickhouse_batch_size`, `clickhouse_flush_duration_ms`

**pprof:** `:6060` (CPU/heap/trace) ‚Äî –¥–ª—è –ø–æ–∏—Å–∫–∞ —É–∑–∫–∏—Ö –º–µ—Å—Ç.

---

## –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ Redpanda ‚áÑ Kafka

1. –í `config.yaml`:

    * `ingest.broker_type: redpanda | kafka`
    * `ingest.brokers: ["redpanda:9092"]` / `["kafka:9092"]`

2. –°–∫—Ä–∏–ø—Ç `build/kafka/create_or_update_topic.sh` (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π):

    * –µ—Å–ª–∏ –µ—Å—Ç—å `rpk` ‚Üí —Å–æ–∑–¥–∞—ë—Ç/—á–∏–Ω–∏—Ç —Ç–æ–ø–∏–∫ –≤ Redpanda,
    * –∏–Ω–∞—á–µ ‚Äî `kafka-topics.sh`/`kafka-configs.sh` –¥–ª—è Kafka.

3. –í `docker-compose.dev.yml` –¥–µ—Ä–∂–∏–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ (Redpanda ‚Äî –¥–µ—Ñ–æ–ª—Ç, Kafka ‚Äî –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω).

**–ü–æ—á–µ–º—É —Ç–∞–∫:** –∫–æ–¥ –Ω–µ –º–µ–Ω—è–µ–º –≤–æ–æ–±—â–µ; –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ ‚Äî –¥–µ–ª–æ –∫–æ–Ω—Ñ–∏–≥–æ–≤ –∏ –∞–¥–º–∏–Ω–∫–∏.

---

## –¢–µ—Å—Ç-–ø–ª–∞–Ω (unit/integration/load)

**Unit:**

* Dedup (Redis): Seen/TTL/—Å–æ—Å—Ç—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å.
* Ring/rolling: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—É–º–º; –≤—ã–ø–∞–¥–∞—é—â–∏–µ –º–∏–Ω—É—Ç—ã; –≥—Ä–∞–Ω–∏—Ü—ã —Å—É—Ç–æ–∫.
* Snapshot/Restore: –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ/–ø–æ—Å–ª–µ.

**Integration:**

* Ingest‚ÜíApply‚ÜíWS‚ÜíRestart‚ÜíRestore‚Üí–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤/–¥—É–±–ª–µ–π.
* Late events (–Ω–∞–ø—Ä–∏–º–µ—Ä, now-90s) –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–ø–∞–¥–∞—é—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—Ç –æ–∫–Ω–∞.

**Load:**

* –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1‚Äì3k EPS –Ω–∞ 10 –º–∏–Ω—É—Ç (–ø—Ä–æ–¥—é—Å–µ—Ä/–∫—Å–∞—Ç–æ—Ä).
* k6: HTTP sustained 1000 RPS, burst 5000 RPS.
* WS: 1000 –∫–ª–∏–µ–Ω—Ç–æ–≤ √ó 5 –ø–æ–¥–ø–∏—Å–æ–∫, –∫–æ–∞–ª–µ—Å–∏–Ω–≥ 100 ms ‚Üí \~50k msg/s.

**HA:**

* 2 –∏–Ω—Å—Ç–∞–Ω—Å–∞: —É–±–∏—Ç—å –æ–¥–∏–Ω ‚Üí –±–µ–∑ –ø–æ—Ç–µ—Ä—å, –ª–∞–≥ ‚âà 0, WS-—Ñ–∞–Ω-–∞—É—Ç —á–µ—Ä–µ–∑ NATS —Ä–∞–±–æ—Ç–∞–µ—Ç.

---

## Runbook (–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞)

* **–†–µ—Å—Ç–∞—Ä—Ç:** –≤—Å–µ–≥–¥–∞ graceful ‚Üí —Ñ–∏–Ω–∞–ª—å–Ω—ã–π Snapshot; –Ω–∞ —Å—Ç–∞—Ä—Ç–µ Restore ‚Üí ‚Äú—Ç—ë–ø–ª—ã–π‚Äù —Å–µ—Ä–≤–∏—Å.
* **–õ–∞–≥ —Ä–∞—Å—Ç—ë—Ç:** –ø—Ä–æ–≤–µ—Ä—è–µ–º consumer lag, CPU, Redis RTT; –¥–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä—Ç–∏—Ü–∏–∏/–∏–Ω—Å—Ç–∞–Ω—Å—ã.
* **Reorg:** `removed=true` ‚Üí –ø—Ä–∏–º–µ–Ω—è–µ–º **–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é** (–≤—ã—á–µ—Å—Ç—å –≤–∫–ª–∞–¥), –ø—É—à–∏–º –ø–∞—Ç—á –≤ WS.
* **Retentions:** Redpanda/Kafka ‚Äî 7 –¥–Ω–µ–π (–≥–æ—Ä—è—á–∏–π –±—É—Ñ–µ—Ä); ClickHouse ‚Äî 90 –¥–Ω–µ–π (–¥–∞–ª—å—à–µ cold/S3 ‚Üí delete).
* **–ü—Ä–æ–≤–µ—Ä–∫–∞ tiering:** —Ä–∞–∑ –≤ –¥–µ–Ω—å –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å system.parts –ø–æ disk_name='s3_cold' –∏ part_log (MovePart).
* **–ê–≤–∞—Ä–∏–∏ S3:** –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ S3 –∑–∞–ø—Ä–æ—Å—ã –∫ —Ö–æ–ª–æ–¥–Ω—ã–º –ø–∞—Ä—Ç–∏—Ü–∏—è–º –¥–µ–≥—Ä–∞–¥–∏—Ä—É—é—Ç/–æ—à–∏–±–∞—é—Ç—Å—è ‚Äî –∞–ª–µ—Ä—Ç—ã –ø–æ system.events.S3* –∏ –ª–æ–≥–∞–º CH.

---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–∫–æ–º–∞–Ω–¥—ã)

**1) –ü–æ–¥–Ω—è—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ:**

```bash
docker compose -f infra/docker/docker-compose.dev.yml up -d
```

**2) –°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ø–∏–∫:**

```bash
./infra/kafka/create_topic.sh \
  raw-swaps 12 604800000 delete 3600000 "localhost:9092"
```

> –°–∫—Ä–∏–ø—Ç —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç: Redpanda (`rpk`) –∏–ª–∏ Kafka‚Äê—É—Ç–∏–ª–∏—Ç—ã.

**3) –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**

```bash
CONFIG=cmd/aggregator/config_dev.yaml go run ./cmd/aggregator
```

**4) –ü—Ä–æ–≤–µ—Ä–∫–∞:**

* `GET /healthz` ‚Äî 200 OK
* `GET /api/tokens/USDC/stats?windows=5m,1h,24h` ‚Äî –¥–∞–Ω–Ω—ã–µ –∏–∑ RAM
* WebSocket `/ws` ‚Üí `{"subscribe":"token:USDC"}` ‚Äî –ø–∞—Ç—á–∏ –∏–¥—É—Ç –∫–∞–∂–¥—ã–µ \~100 ms

---

### –ü–æ—á–µ–º—É —ç—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–∞–¥—ë–∂–Ω–∞ –∏ –±—ã—Å—Ç—Ä–∞

* **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** + **at-least-once** = –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏.
* **Ring + rolling** = O(1) –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –Ω–∞ —Ç–æ–∫–µ–Ω.
* **Grace** = –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å out-of-order –±–µ–∑ –±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏.
* **Snapshot/Restore** = –±—ã—Å—Ç—Ä—ã–π —Ç—ë–ø–ª—ã–π —Å—Ç–∞—Ä—Ç, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π RTO(—Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è).
* **ClickHouse** = –¥–µ—à—ë–≤–æ–µ –∏ –±—ã—Å—Ç—Ä–æ–µ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å –≥–æ—Ç–æ–≤—ã–º–∏ –≤–∏—Ç—Ä–∏–Ω–∞–º–∏.
* **WS —Å –∫–æ–∞–ª–µ—Å–∏–Ω–≥–æ–º** = realtime –±–µ–∑ —Ñ–ª—É–¥–∞, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ NATS.

---


## –ß–µ–º –±—É–¥–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è PROD-config –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ dev

### Ingest (Redpanda/Kafka)

* `brokers`: —Å–ø–∏—Å–æ–∫ –∏–∑ **–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö** –±—Ä–æ–∫–µ—Ä–æ–≤ (DNS/–±–∞–ª–∞–Ω—Å–µ—Ä –∏–ª–∏ –ø—Ä—è–º—ã–µ –∞–¥—Ä–µ—Å–∞).
* **TLS/SASL**: –≤–∫–ª—é—á–∏—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é (mTLS –∏–ª–∏ SASL SCRAM).
  –í –∫–æ–Ω—Ñ–∏–≥ –¥–æ–±–∞–≤—è—Ç—Å—è –ø–æ–ª—è –≤–∏–¥–∞:

  ```yaml
  ingest:
    tls:
      enabled: true
      ca_file: "/etc/ssl/ca.pem"
      cert_file: "/etc/ssl/app.crt"
      key_file: "/etc/ssl/app.key"
    sasl:
      enabled: true
      mechanism: "SCRAM-SHA-256"
      username: "client"
      password: "****"
  ```
* `max_inflight`: –ø–æ–¥–Ω—è—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 256‚Äì1024) –ø–æ—Å–ª–µ –∑–∞–º–µ—Ä–∞ CPU/RAM.
* –¢–∞–π–º–∏–Ω–≥–∏: —á–∞—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è—é—Ç `session_timeout=30s`, `rebalance_timeout=120s` –≤ –±–æ–ª—å—à–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞—Ö.

> –ö–æ–ª-–≤–æ –ø–∞—Ä—Ç–∏—Ü–∏–π –∏ retention –Ω–∞ —Ç–æ–ø–∏–∫–µ ‚Äî —ç—Ç–æ —É–∂–µ –Ω–µ `config.yaml` –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∞ –ø–æ–ª–∏—Ç–∏–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞. –í –ø—Ä–æ–¥–µ: **—Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è=3**, **–ø–∞—Ä—Ç–∏—Ü–∏–π** ‚Äî –ø–æ —Ü–µ–ª–µ–≤–æ–π –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤.

### Redis (–¥–µ–¥—É–ø/—Å–Ω–∞–ø—à–æ—Ç—ã/–ª–∏–º–∏—Ç—ã)

* –ü–∞—Ä–æ–ª—å/TLS:

  ```yaml
  stores:
    redis:
      addr: "redis:6379"
      username: "default"
      password: "****"
      tls: true
      db: 2
  ```
* –í –ø—Ä–æ–¥–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç **Redis Sentinel** –∏–ª–∏ **Cluster** (–¥—Ä—É–≥–∏–µ –∞–¥—Ä–µ—Å–∞/URI).

### ClickHouse (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ)

* –†–µ–∞–ª—å–Ω—ã–π DSN (–∞ –Ω–µ localhost) + —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ / TLS.
* –ü–æ–ª–∏—Ç–∏–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è (S3) –∏ TTL –¥–æ–ª—å—à–µ/—Å—Ç—Ä–æ–∂–µ. –í dev 90d –æ–∫; –≤ –ø—Ä–æ–¥–µ ‚Äî –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.

### NATS (—Ñ–∞–Ω-–∞—É—Ç)

* –í–∫–ª—é—á–∏—Ç—å **–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é** (user/pass, nkey –∏–ª–∏ JWT), –≤–æ–∑–º–æ–∂–µ–Ω –∫–ª–∞—Å—Ç–µ—Ä –∏–∑ 3 –Ω–æ–¥, –∫–≤–æ—Ç—ã JetStream (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ, —Ä–µ—Ç–µ–Ω—à–Ω).

### JWT (RS256)

* –ü–æ–º–µ–Ω—è—Ç—å –ø—É—Ç–∏ –∫ –∫–ª—é—á–∞–º –∏ —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞ –ø—Ä–æ–¥–æ–≤—ã–µ, –¥–æ–±–∞–≤–∏—Ç—å —Ä–æ—Ç–∞—Ü–∏—é –∫–ª—é—á–µ–π (kid/–∫–ª—é—á–µ–≤–æ–π –Ω–∞–±–æ—Ä):

  ```yaml
  security:
    jwt:
      enabled: true
      alg: "RS256"
      public_key_path: "/etc/keys/jwt.pub"
      private_key_path: "/etc/keys/jwt.pem"
      audience: "swap-stats-prod"
      issuer: "https://auth.example.com"
      leeway_sec: 30
  ```
* –ß–∞—Å—Ç–æ –≤ –ø—Ä–æ–¥–µ **–∑–∞–ø—Ä–µ—â–∞—é—Ç** –¥–æ—Å—Ç—É–ø –±–µ–∑ JWT (—É–∂–µ `enabled: true`).

### Rate limit

* –ß–∏—Å–ª–∞ –º–µ–Ω—è—é—Ç—Å—è –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:
  –±–æ–ª—å—à–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Üí –≤—ã—à–µ `refill_per_sec`, –Ω–æ –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–µ–µ —Å `burst`, —á—Ç–æ–±—ã –Ω–µ —Å—Ö–ª–æ–ø–Ω—É—Ç—å—Å—è –ø–∏–∫–∞–º–∏.

### –°–Ω–∞–ø—à–æ—Ç—ã/Grace

* `snapshot_interval`: –∏–Ω–æ–≥–¥–∞ **—É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç** –¥–æ 10‚Äì30s, —á—Ç–æ–±—ã —É–º–µ–Ω—å—à–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ Redis.
* `grace`: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–∞–¥–µ—Ä–∂–µ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞. –ï—Å–ª–∏ –±—ã–≤–∞—é—Ç –ø–æ–∑–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è, –ø–æ–¥–Ω–∏–º—É—Ç –¥–æ 180‚Äì300s.

### API/Network

* `api.http.addr: ":8080"` –æ—Å—Ç–∞–Ω–µ—Ç—Å—è, –Ω–æ –≤ –ø—Ä–æ–¥–µ –æ–±—ã—á–Ω–æ –≤—Å—Ç–∞—ë—Ç –ø–µ—Ä–µ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º **reverse proxy** (nginx/Envoy) + mTLS, CORS/headers.

---

#### –ú–∏–Ω–∏-–ø—Ä–∏–º–µ—Ä —á–µ–º –±—É–¥–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```diff
 ingest:
-  brokers: ["redpanda:9092"]
+  brokers: ["kafka-1:9092","kafka-2:9092","kafka-3:9092"]
+  tls:
+    enabled: true
+    ca_file: "/etc/ssl/ca.pem"
+    cert_file: "/etc/ssl/app.crt"
+    key_file: "/etc/ssl/app.key"
+  sasl:
+    enabled: true
+    mechanism: "SCRAM-SHA-256"
+    username: "app"
+    password: "****"
-  max_inflight: 64
+  max_inflight: 256
-  rebalance_timeout: "60s"
+  rebalance_timeout: "120s"

 stores:
   redis:
-    addr: "redis:6379"
+    addr: "redis-sentinel:26379"
+    sentinel_master: "mymaster"
+    username: "default"
+    password: "****"
+    tls: true

 security:
   jwt:
-    public_key_path: "./secrets/jwt.pub"
-    private_key_path: "./secrets/jwt.pem"
+    public_key_path: "/etc/keys/prod-jwt.pub"
+    private_key_path: "/etc/keys/prod-jwt.pem"
+    audience: "swap-stats-prod"
+    issuer: "https://auth.example.com"

 rate_limit:
   by_jwt:
-    refill_per_sec: 50
-    burst: 200
+    refill_per_sec: 200
+    burst: 400
   by_ip:
-    refill_per_sec: 20
-    burst: 60
+    refill_per_sec: 50
+    burst: 150

 app:
-  snapshot_interval: "5s"
+  snapshot_interval: "15s"
-  grace: "120s"
+  grace: "180s"

 stores:
   clickhouse:
-    dsn: "tcp://clickhouse:9000?database=swaps&compress=true"
+    dsn: "tcp://ch-proxy:9000?database=swaps&secure=true&user=app&password=****"
```

> –≠—Ç–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä: —Ç–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–¥–±–∏—Ä–∞—Ç—å –æ—Ç—Ç–∞–ª–∫–∏–≤–∞—è—Å—å –±–æ–ª—å—à–µ –æ—Ç –ù–§–¢ –∏ –ø–æ –∑–∞–º–µ—Ä–∞–º
